# SE-QPT Docker Compose - Production (DigitalOcean)
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  db:
    # Use smaller shared_buffers for 2GB droplet
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=512MB
      -c maintenance_work_mem=64MB
      -c work_mem=16MB
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  backend:
    # Remove volume mount in production
    volumes: []
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SECRET_KEY=${SECRET_KEY}
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    # Production command with optimized workers
    command: ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "2", "--threads", "2", "--timeout", "120", "--max-requests", "1000", "--max-requests-jitter", "100", "run:app"]

  frontend:
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
